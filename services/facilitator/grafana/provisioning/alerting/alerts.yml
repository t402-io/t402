apiVersion: 1

groups:
  - orgId: 1
    name: T402 Facilitator - Critical Alerts
    folder: T402
    interval: 30s
    rules:
      # Service Down Alert - Highest priority
      - uid: t402-service-down
        title: Facilitator Service Down
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: up{job="facilitator"}
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: T402 Facilitator service is down
          description: "Facilitator service is not responding to health checks. Immediate action required."
          runbook_url: "https://docs.t402.io/runbooks/facilitator-down"
        labels:
          severity: critical
          service: facilitator
          team: platform

      # Redis Down Alert
      - uid: t402-redis-down
        title: Redis Service Down
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: redis_up
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: Redis service is down
          description: "Redis is not responding. Rate limiting and caching functionality is impacted."
          runbook_url: "https://docs.t402.io/runbooks/redis-down"
        labels:
          severity: critical
          service: redis
          team: platform

  - orgId: 1
    name: T402 Facilitator - SLO Alerts
    folder: T402
    interval: 1m
    rules:
      # High Error Rate Alert (SLO: 99.9% availability = <0.1% 5xx errors)
      - uid: t402-high-error-rate
        title: High Error Rate (SLO Breach)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.001
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: High error rate breaching 99.9% SLO
          description: "Error rate is above 0.1% (current: {{ $values.C | printf \"%.4f\" }}). SLO target: 99.9% availability."
          runbook_url: "https://docs.t402.io/runbooks/high-error-rate"
        labels:
          severity: critical
          service: facilitator
          team: platform
          slo: availability

      # High Latency Alert (SLO: P95 < 500ms)
      - uid: t402-high-latency
        title: High P95 Latency (SLO Breach)
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: histogram_quantile(0.95, sum(rate(facilitator_request_duration_seconds_bucket[5m])) by (le))
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.5
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High P95 latency breaching SLO
          description: "P95 latency is above 500ms (current: {{ $values.A | printf \"%.3f\" }}s). SLO target: P95 < 500ms."
          runbook_url: "https://docs.t402.io/runbooks/high-latency"
        labels:
          severity: warning
          service: facilitator
          team: platform
          slo: latency

      # Very High Latency Alert (P99 > 2s)
      - uid: t402-very-high-latency
        title: Very High P99 Latency
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: histogram_quantile(0.99, sum(rate(facilitator_request_duration_seconds_bucket[5m])) by (le))
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 3m
        annotations:
          summary: Very high P99 latency detected
          description: "P99 latency is above 2s (current: {{ $values.A | printf \"%.3f\" }}s). User experience is significantly impacted."
        labels:
          severity: critical
          service: facilitator
          team: platform

  - orgId: 1
    name: T402 Facilitator - Payment Alerts
    folder: T402
    interval: 1m
    rules:
      # Verify Endpoint Errors
      - uid: t402-verify-errors
        title: Verify Endpoint Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{endpoint="/verify",status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: Verify endpoint returning errors
          description: "The /verify endpoint is returning 5xx errors. Payment verification is failing."
          runbook_url: "https://docs.t402.io/runbooks/verify-errors"
        labels:
          severity: critical
          service: facilitator
          team: payments

      # Settle Endpoint Errors
      - uid: t402-settle-errors
        title: Settle Endpoint Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{endpoint="/settle",status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: Settle endpoint returning errors
          description: "The /settle endpoint is returning 5xx errors. Payment settlement is failing - funds may not be transferred."
          runbook_url: "https://docs.t402.io/runbooks/settle-errors"
        labels:
          severity: critical
          service: facilitator
          team: payments

      # Low Settlement Success Rate
      - uid: t402-low-settlement-rate
        title: Low Settlement Success Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{result="success"}[10m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total[10m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.95
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: Low settlement success rate
          description: "Settlement success rate is below 95% (current: {{ $values.C | printf \"%.2f\" }}). Payments may be failing to settle."
        labels:
          severity: warning
          service: facilitator
          team: payments

      # Low Verification Success Rate
      - uid: t402-low-verification-rate
        title: Low Verification Success Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_verify_total{result="success"}[10m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_verify_total[10m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.90
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: Low verification success rate
          description: "Verification success rate is below 90% (current: {{ $values.C | printf \"%.2f\" }}). Many payments are failing verification."
        labels:
          severity: warning
          service: facilitator
          team: payments

  - orgId: 1
    name: T402 Facilitator - Warning Alerts
    folder: T402
    interval: 2m
    rules:
      # High Client Error Rate (4xx errors)
      - uid: t402-high-client-errors
        title: High Client Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{status=~"4.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.15
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High client error rate
          description: "Client error rate (4xx) is above 15% (current: {{ $values.C | printf \"%.2f\" }}). May indicate integration issues."
        labels:
          severity: warning
          service: facilitator
          team: platform

      # Redis Memory Warning
      - uid: t402-redis-memory-high
        title: Redis Memory Usage High
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: redis_memory_used_bytes
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: redis_memory_max_bytes
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.8
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: Redis memory usage is high
          description: "Redis memory usage is above 80% (current: {{ $values.C | printf \"%.2f\" }}). Consider scaling or cleaning up."
        labels:
          severity: warning
          service: redis
          team: platform

      # Network-Specific Error Rate - EVM
      - uid: t402-evm-errors
        title: High Error Rate on EVM Networks
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"eip155:.*",result="failure"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"eip155:.*"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High error rate on EVM networks
          description: "Settlement error rate on EVM networks is above 10% (current: {{ $values.C | printf \"%.2f\" }}). Check RPC providers."
        labels:
          severity: warning
          service: facilitator
          team: payments
          network: evm

      # Network-Specific Error Rate - Solana
      - uid: t402-solana-errors
        title: High Error Rate on Solana Networks
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"solana:.*",result="failure"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"solana:.*"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High error rate on Solana networks
          description: "Settlement error rate on Solana networks is above 10% (current: {{ $values.C | printf \"%.2f\" }}). Check RPC providers."
        labels:
          severity: warning
          service: facilitator
          team: payments
          network: solana

      # Network-Specific Error Rate - TON
      - uid: t402-ton-errors
        title: High Error Rate on TON Networks
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"ton:.*",result="failure"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"ton:.*"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High error rate on TON networks
          description: "Settlement error rate on TON networks is above 10% (current: {{ $values.C | printf \"%.2f\" }}). Check TON RPC providers."
        labels:
          severity: warning
          service: facilitator
          team: payments
          network: ton

      # Network-Specific Error Rate - TRON
      - uid: t402-tron-errors
        title: High Error Rate on TRON Networks
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"tron:.*",result="failure"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_settle_total{network=~"tron:.*"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High error rate on TRON networks
          description: "Settlement error rate on TRON networks is above 10% (current: {{ $values.C | printf \"%.2f\" }}). Check TRON RPC providers."
        labels:
          severity: warning
          service: facilitator
          team: payments
          network: tron

  - orgId: 1
    name: T402 Facilitator - Security Alerts
    folder: T402
    interval: 30s
    rules:
      # API Key Authentication Attacks
      - uid: t402-apikey-auth-attacks
        title: API Key Authentication Attacks Detected
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_api_key_auth_failed_total[5m])) * 300
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 10
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 1m
        annotations:
          summary: Potential API key brute force attack detected
          description: "More than 10 failed API key authentication attempts in 5 minutes. Possible brute force attack."
          runbook_url: "https://docs.t402.io/runbooks/api-key-attacks"
        labels:
          severity: critical
          service: facilitator
          team: security

      # Rate Limit Saturation
      - uid: t402-rate-limit-saturation
        title: Rate Limit Saturation
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{status="429"}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High rate of rate-limited requests
          description: "More than 10% of requests are being rate limited (current: {{ $values.C | printf \"%.2f\" }}). Consider adjusting rate limits or investigating traffic patterns."
        labels:
          severity: warning
          service: facilitator
          team: platform
