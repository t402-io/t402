name: NPM Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      package:
        description: "Package to publish"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - core
          - extensions
          - evm
          - svm
          - ton
          - tron
          - express
          - next
          - hono
          - fastify
          - fetch
          - axios
          - paywall
          - react
          - vue
          - wdk
          - wdk-gasless
          - wdk-bridge
          - wdk-multisig
          - mcp
          - cli
      dry_run:
        description: "Dry run (no actual publish)"
        required: false
        default: false
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: ./typescript

      - name: Install dependencies
        working-directory: ./typescript
        run: pnpm install --frozen-lockfile

      - name: Run tests
        working-directory: ./typescript
        run: pnpm test

  publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Core packages
          - name: core
            path: packages/core
          - name: extensions
            path: packages/extensions
          # Mechanism packages
          - name: evm
            path: packages/mechanisms/evm
          - name: svm
            path: packages/mechanisms/svm
          - name: ton
            path: packages/mechanisms/ton
          - name: tron
            path: packages/mechanisms/tron
          # HTTP server packages
          - name: express
            path: packages/http/express
          - name: next
            path: packages/http/next
          - name: hono
            path: packages/http/hono
          - name: fastify
            path: packages/http/fastify
          # HTTP client packages
          - name: fetch
            path: packages/http/fetch
          - name: axios
            path: packages/http/axios
          # UI packages
          - name: paywall
            path: packages/http/paywall
          - name: react
            path: packages/http/react
          - name: vue
            path: packages/http/vue
          # WDK packages
          - name: wdk
            path: packages/wdk
          - name: wdk-gasless
            path: packages/wdk-gasless
          - name: wdk-bridge
            path: packages/wdk-bridge
          - name: wdk-multisig
            path: packages/wdk-multisig
          # Tool packages
          - name: mcp
            path: packages/mcp
          - name: cli
            path: packages/cli
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: ./typescript
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        working-directory: ./typescript
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        working-directory: ./typescript
        run: pnpm build

      - name: Publish @t402/${{ matrix.name }}
        if: ${{ github.event.inputs.package == 'all' || github.event.inputs.package == matrix.name || github.event_name == 'push' }}
        working-directory: ./typescript/${{ matrix.path }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            pnpm publish --access public --no-git-checks --dry-run
          else
            pnpm publish --access public --no-git-checks || echo "Package may already exist at this version"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
