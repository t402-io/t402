# TypeScript SDK

The T402 TypeScript SDK provides comprehensive support for HTTP-native stablecoin payments across multiple blockchains.

import { Callout } from 'nextra/components'

<Callout type="info">
  **v2.0.0 Released** - All packages are now published under the `@t402` namespace on npm.
</Callout>

## Core Packages

| Package | Version | Description |
|---------|---------|-------------|
| `@t402/core` | 2.0.0 | Protocol types and HTTP utilities |
| `@t402/extensions` | 2.0.0 | Protocol extensions and helpers |

## Blockchain Mechanisms

| Package | Version | Description |
|---------|---------|-------------|
| `@t402/evm` | 2.2.0 | EVM chains (Ethereum, Arbitrum, Base, etc.) with EIP-3009 |
| `@t402/evm-core` | 2.2.0 | EVM types and utilities without viem dependency |
| `@t402/svm` | 2.0.0 | Solana blockchain with SPL token transfers |
| `@t402/ton` | 2.1.0 | TON blockchain with USDT Jetton support |
| `@t402/tron` | 2.0.0 | TRON blockchain with TRC-20 USDT |

<Callout type="info">
  **Bundle Size Optimization**: Use `@t402/evm-core` instead of `@t402/evm` if you only need types and don't require viem. This significantly reduces bundle size for type-only consumers.
</Callout>

## WDK Integration (Tether Wallet Development Kit)

| Package | Version | Description |
|---------|---------|-------------|
| `@t402/wdk` | 2.0.1 | Tether WDK integration for self-custodial wallets |
| `@t402/wdk-gasless` | 1.0.0 | Gasless payments via ERC-4337 account abstraction |
| `@t402/wdk-bridge` | 1.0.0 | Cross-chain bridging via LayerZero OFT |
| `@t402/wdk-multisig` | 1.0.0 | Safe multi-signature wallet support |

## HTTP Server Frameworks

| Framework | Package | Version |
|-----------|---------|---------|
| Express.js | `@t402/express` | 2.0.0 |
| Next.js | `@t402/next` | 2.0.0 |
| Hono | `@t402/hono` | 2.0.0 |
| Fastify | `@t402/fastify` | 2.0.0 |

## HTTP Client Libraries

| Client | Package | Version |
|--------|---------|---------|
| Fetch API | `@t402/fetch` | 2.0.0 |
| Axios | `@t402/axios` | 2.0.0 |

## UI Components

| Package | Version | Description |
|---------|---------|-------------|
| `@t402/paywall` | 2.0.0 | Universal paywall component (framework-agnostic) |
| `@t402/react` | 2.0.0 | React hooks and components |
| `@t402/vue` | 2.0.0 | Vue 3 composables and components |

## Tools

| Package | Version | Description |
|---------|---------|-------------|
| `@t402/cli` | 2.0.0 | Command-line tools for testing and development |
| `@t402/mcp` | 1.0.0 | MCP server for AI agent payments |

## Quick Install

```bash
# Core + EVM (most common)
pnpm add @t402/core @t402/evm

# With Express middleware
pnpm add @t402/core @t402/evm @t402/express

# Full client setup with fetch wrapper
pnpm add @t402/core @t402/evm @t402/fetch

# Multi-chain support
pnpm add @t402/core @t402/evm @t402/svm @t402/ton @t402/tron
```

## Architecture

```
@t402/core                  Base types, HTTP utilities
    │
    ├── @t402/evm-core      EVM types and constants (no viem dependency)
    │       │
    │       └── @t402/evm   EVM mechanism (EIP-3009, ERC-4337, LayerZero)
    │
    ├── @t402/svm           Solana mechanism (SPL tokens)
    │
    ├── @t402/ton           TON mechanism (Jettons)
    │
    ├── @t402/tron          TRON mechanism (TRC-20)
    │
    └── @t402/wdk           Tether WDK integration
        │
        ├── @t402/wdk-gasless   ERC-4337 gasless payments
        │
        ├── @t402/wdk-bridge    LayerZero cross-chain bridge
        │
        └── @t402/wdk-multisig  Safe multi-sig wallets
```

## Quick Start

### Client (Make Payments)

```typescript
import { t402Client, wrapFetchWithPayment } from "@t402/fetch";
import { registerExactEvmScheme } from "@t402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";

// Create t402 client
const client = new t402Client();

// Register EVM payment mechanism
registerExactEvmScheme(client, {
  signer: privateKeyToAccount(process.env.PRIVATE_KEY as `0x${string}`),
});

// Wrap fetch for automatic payment handling
const fetchWithPayment = wrapFetchWithPayment(fetch, client);

// Make request - 402 payments handled automatically
const response = await fetchWithPayment("https://api.example.com/data");
const data = await response.json();
```

### Server (Require Payments)

```typescript
import express from "express";
import { paymentMiddleware, t402ResourceServer } from "@t402/express";
import { ExactEvmScheme } from "@t402/evm/exact/server";

const app = express();

// Configure payment routes
app.use(
  paymentMiddleware(
    {
      "GET /api/data": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.01",
            network: "eip155:8453",
            payTo: "0xYourAddress",
          },
        ],
        description: "Premium API data",
        mimeType: "application/json",
      },
    },
    new t402ResourceServer(facilitatorClient)
      .register("eip155:8453", new ExactEvmScheme()),
  ),
);

// Protected endpoint
app.get("/api/data", (req, res) => {
  res.json({ message: "Premium content!" });
});

app.listen(3000);
```

## Gasless Payments (ERC-4337)

Enable gasless payments using account abstraction:

```typescript
import {
  SafeSmartAccount,
  createBundlerClient,
  createPaymaster,
} from "@t402/evm/erc4337";
import { privateKeyToAccount } from "viem/accounts";

// Create Safe smart account
const safeAccount = new SafeSmartAccount({
  owner: privateKeyToAccount(ownerPrivateKey),
  chainId: 8453, // Base
});

// Create bundler and paymaster clients
const bundler = createBundlerClient({
  provider: "pimlico",
  apiKey: process.env.PIMLICO_API_KEY,
  chainId: 8453,
});

const paymaster = createPaymaster({
  provider: "pimlico",
  apiKey: process.env.PIMLICO_API_KEY,
  chainId: 8453,
});

// Build and send UserOperation
const callData = safeAccount.encodeExecute(targetAddress, 0n, data);
const userOp = await bundler.buildUserOperation({
  sender: smartAccountAddress,
  callData,
});

// Sponsor with paymaster
const sponsoredOp = await paymaster.sponsor(userOp);

// Send UserOperation
const hash = await bundler.sendUserOperation({
  ...sponsoredOp,
  signature: await safeAccount.signUserOp(sponsoredOp),
});

// Wait for receipt
const receipt = await bundler.waitForReceipt(hash);
```

## Cross-Chain Bridge (USDT0)

Bridge USDT0 between chains using LayerZero:

```typescript
import { Usdt0Bridge, LayerZeroScanClient } from "@t402/evm";

// Create bridge client
const bridge = new Usdt0Bridge(signer, "arbitrum");

// Get quote
const quote = await bridge.quote({
  fromChain: "arbitrum",
  toChain: "ethereum",
  amount: 100_000000n, // 100 USDT0
  recipient: "0xRecipientAddress",
});

console.log(`Fee: ${quote.nativeFee}`);

// Execute bridge
const result = await bridge.send({ ...quote });
console.log(`Message GUID: ${result.messageGuid}`);

// Track status
const scanClient = new LayerZeroScanClient();
await scanClient.waitForDelivery(result.messageGuid);
console.log("Bridge complete!");
```

## MCP Server (AI Agents)

Run an MCP server for AI agent payments:

```bash
# Install and run MCP server
npx @t402/mcp
```

Configure in Claude Desktop:

```json
{
  "mcpServers": {
    "t402": {
      "command": "npx",
      "args": ["@t402/mcp"],
      "env": {
        "T402_DEMO_MODE": "true"
      }
    }
  }
}
```

See [MCP Integration](/sdks/typescript/mcp) for full documentation.

## Framework Integration Patterns

### Next.js App Router

```typescript
// app/api/premium/route.ts
import { createT402Handler } from "@t402/next";
import { ExactEvmScheme } from "@t402/evm/exact/server";

export const GET = createT402Handler(
  async (req) => {
    return Response.json({ data: "Premium content!" });
  },
  {
    accepts: [
      { scheme: "exact", price: "$0.01", network: "eip155:8453", payTo: "0x..." },
    ],
    description: "Premium API endpoint",
  }
);
```

### Hono

```typescript
import { Hono } from "hono";
import { paymentMiddleware } from "@t402/hono";

const app = new Hono();

app.use(
  "/api/*",
  paymentMiddleware({
    "GET /api/data": {
      accepts: [{ scheme: "exact", price: "$0.01", network: "eip155:8453", payTo: "0x..." }],
    },
  })
);

app.get("/api/data", (c) => c.json({ data: "Premium!" }));
```

### Fastify

```typescript
import Fastify from "fastify";
import { t402Plugin } from "@t402/fastify";

const app = Fastify();

app.register(t402Plugin, {
  routes: {
    "GET /api/data": {
      accepts: [{ scheme: "exact", price: "$0.01", network: "eip155:8453", payTo: "0x..." }],
    },
  },
});

app.get("/api/data", async () => ({ data: "Premium!" }));
```

### Axios Client

```typescript
import axios from "axios";
import { createT402Interceptor } from "@t402/axios";
import { registerExactEvmScheme } from "@t402/evm/exact/client";

const client = new t402Client();
registerExactEvmScheme(client, { signer });

const axiosInstance = axios.create();
axiosInstance.interceptors.request.use(createT402Interceptor(client));

const response = await axiosInstance.get("https://api.example.com/data");
```

## Lifecycle Hooks

### Client Hooks

```typescript
import { t402Client } from "@t402/core";

const client = new t402Client();

// Before payment creation
client.onBeforePaymentCreation((ctx) => {
  console.log(`Creating payment for ${ctx.requirements.network}`);

  // Abort if price too high
  if (BigInt(ctx.requirements.maxAmountRequired) > MAX_PRICE) {
    return { abort: true, reason: "Price exceeds limit" };
  }
});

// After successful payment
client.onAfterPaymentCreation((ctx) => {
  metrics.increment("payments.created", {
    network: ctx.requirements.network,
    scheme: ctx.requirements.scheme,
  });
});

// On payment failure
client.onPaymentCreationFailure((ctx) => {
  logger.error("Payment failed", { error: ctx.error });
});
```

### Server Hooks

```typescript
import { t402ResourceServer } from "@t402/core";

const server = new t402ResourceServer(facilitator);

// Before verification
server.onBeforeVerify((ctx) => {
  if (isBlacklisted(ctx.payload.authorization.from)) {
    return { abort: true, reason: "Payer is blocked" };
  }
});

// After successful settlement
server.onAfterSettle((ctx) => {
  db.recordPayment({
    txHash: ctx.result.transaction,
    payer: ctx.result.payer,
    amount: ctx.requirements.maxAmountRequired,
  });
});
```

## Error Handling

### Client-Side Errors

```typescript
import { t402Client, PaymentError, PaymentAbortedError } from "@t402/core";

try {
  const response = await fetchWithPayment("https://api.example.com/data");
} catch (error) {
  if (error instanceof PaymentAbortedError) {
    // Payment was aborted by a hook
    console.log("Payment aborted:", error.reason);
  } else if (error instanceof PaymentError) {
    // Payment creation failed
    console.log("Payment failed:", error.message);
  } else {
    // Network or other error
    throw error;
  }
}
```

### Server-Side Errors

```typescript
import { paymentMiddleware } from "@t402/express";

app.use(
  paymentMiddleware(routes, server, {
    onError: (error, req, res) => {
      logger.error("Payment error", { error, path: req.path });
      res.status(500).json({ error: "Payment processing failed" });
    },
    onSettlement: (result, req) => {
      logger.info("Payment settled", {
        txHash: result.transaction,
        payer: result.payer,
      });
    },
  })
);
```

## Dynamic Pricing

### Per-Request Pricing

```typescript
app.use(
  paymentMiddleware({
    "GET /api/data": {
      accepts: [
        {
          scheme: "exact",
          network: "eip155:8453",
          payTo: "0x...",
          // Dynamic price based on request
          price: (req) => {
            const tier = getUserTier(req);
            return tier === "premium" ? "$0.001" : "$0.01";
          },
        },
      ],
    },
  })
);
```

### Dynamic PayTo Address

```typescript
app.use(
  paymentMiddleware({
    "GET /api/marketplace/:id": {
      accepts: [
        {
          scheme: "exact",
          network: "eip155:8453",
          price: "$10.00",
          // Route payment to seller
          payTo: async (req) => {
            const item = await db.getItem(req.params.id);
            return item.sellerAddress;
          },
        },
      ],
    },
  })
);
```

## Testing

### Unit Testing

```typescript
import { describe, it, expect, vi } from "vitest";
import { t402Client } from "@t402/core";

describe("t402Client", () => {
  it("should create payment payload", async () => {
    const client = new t402Client();
    const mockScheme = {
      createPaymentPayload: vi.fn().mockResolvedValue({
        t402Version: 2,
        authorization: { /* ... */ },
        signature: "0x...",
      }),
    };

    client.register("eip155:8453", mockScheme);

    const payload = await client.createPaymentPayload(requirements);
    expect(payload.t402Version).toBe(2);
  });
});
```

### Integration Testing

```typescript
import { describe, it, expect, beforeAll, afterAll } from "vitest";
import express from "express";
import { paymentMiddleware, t402ResourceServer } from "@t402/express";

describe("Payment Middleware", () => {
  let server: ReturnType<typeof express>;

  beforeAll(() => {
    server = express();
    server.use(paymentMiddleware(routes, resourceServer));
    server.get("/api/data", (req, res) => res.json({ data: "test" }));
    server.listen(3001);
  });

  it("should return 402 without payment", async () => {
    const response = await fetch("http://localhost:3001/api/data");
    expect(response.status).toBe(402);

    const body = await response.json();
    expect(body.t402Version).toBe(2);
    expect(body.accepts).toHaveLength(1);
  });
});
```

### Mock Facilitator

```typescript
import { MockFacilitatorClient } from "@t402/core/testing";

const mockFacilitator = new MockFacilitatorClient({
  verifyResponse: { isValid: true },
  settleResponse: { success: true, transaction: "0xmock..." },
});

const server = new t402ResourceServer(mockFacilitator);
```

## Supported Networks

| Chain | Token | CAIP-2 Identifier |
|-------|-------|-------------------|
| Ethereum | USDT0 | `eip155:1` |
| Base | USDT0 | `eip155:8453` |
| Arbitrum | USDT0 | `eip155:42161` |
| Optimism | USDT0 | `eip155:10` |
| Ink | USDT0 | `eip155:57073` |
| Berachain | USDT0 | `eip155:80094` |
| Unichain | USDT0 | `eip155:130` |
| Solana | USDC | `solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp` |
| TON | USDT | `ton:mainnet` |
| TRON | USDT | `tron:mainnet` |

## Development

```bash
# Clone and install
git clone https://github.com/t402-io/t402.git
cd t402/typescript
pnpm install

# Build all packages
pnpm build

# Run tests
pnpm test

# Type checking
pnpm typecheck

# Lint
pnpm lint
```

## Monorepo Structure

```
typescript/
├── packages/
│   ├── core/           # @t402/core
│   ├── extensions/     # @t402/extensions
│   ├── mechanisms/     # @t402/evm, @t402/svm, @t402/ton, @t402/tron
│   ├── http/           # @t402/express, @t402/next, @t402/hono, etc.
│   ├── wdk/            # @t402/wdk
│   ├── wdk-gasless/    # @t402/wdk-gasless
│   ├── wdk-bridge/     # @t402/wdk-bridge
│   ├── wdk-multisig/   # @t402/wdk-multisig
│   ├── mcp/            # @t402/mcp
│   └── cli/            # @t402/cli
└── pnpm-workspace.yaml
```

## Requirements

- Node.js 18+ or Bun 1.0+
- TypeScript 5.0+ (recommended)
- ESM or CommonJS supported
