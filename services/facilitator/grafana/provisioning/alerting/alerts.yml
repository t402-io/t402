apiVersion: 1

groups:
  - orgId: 1
    name: T402 Facilitator Alerts
    folder: T402
    interval: 1m
    rules:
      # High Error Rate Alert (5xx errors)
      - uid: t402-high-error-rate
        title: High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.05
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: High error rate detected on T402 Facilitator
          description: "Error rate is above 5% (current: {{ $values.C }})"
        labels:
          severity: critical
          service: facilitator

      # High Latency Alert (P95 > 1s)
      - uid: t402-high-latency
        title: High P95 Latency
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: histogram_quantile(0.95, sum(rate(facilitator_request_duration_seconds_bucket[5m])) by (le))
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High latency detected on T402 Facilitator
          description: "P95 latency is above 1 second (current: {{ $values.A }}s)"
        labels:
          severity: warning
          service: facilitator

      # Service Down Alert
      - uid: t402-service-down
        title: Facilitator Service Down
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: up{job="facilitator"}
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: T402 Facilitator service is down
          description: "Facilitator service is not responding to health checks"
        labels:
          severity: critical
          service: facilitator

      # High Client Error Rate (4xx errors)
      - uid: t402-high-client-errors
        title: High Client Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{status=~"4.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.2
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $A / $B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: math
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High client error rate on T402 Facilitator
          description: "Client error rate (4xx) is above 20% (current: {{ $values.C }})"
        labels:
          severity: warning
          service: facilitator

      # Redis Down Alert
      - uid: t402-redis-down
        title: Redis Service Down
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: redis_up
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: Redis service is down
          description: "Redis is not responding, rate limiting may not work"
        labels:
          severity: critical
          service: redis

      # Verify Endpoint Errors
      - uid: t402-verify-errors
        title: Verify Endpoint Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{endpoint="/verify",status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: Verify endpoint returning errors
          description: "The /verify endpoint is returning 5xx errors"
        labels:
          severity: critical
          service: facilitator

      # Settle Endpoint Errors
      - uid: t402-settle-errors
        title: Settle Endpoint Errors
        condition: B
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: sum(rate(facilitator_requests_total{endpoint="/settle",status=~"5.."}[5m])) or vector(0)
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    type: last
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: Settle endpoint returning errors
          description: "The /settle endpoint is returning 5xx errors"
        labels:
          severity: critical
          service: facilitator
